var z=function(){"use strict";let g=()=>{},y={morphStyle:"outerHTML",callbacks:{beforeNodeAdded:g,afterNodeAdded:g,beforeNodeMorphed:g,afterNodeMorphed:g,beforeNodeRemoved:g,afterNodeRemoved:g,beforeAttributeUpdated:g},head:{style:"merge",shouldPreserve:l=>l.getAttribute("im-preserve")==="true",shouldReAppend:l=>l.getAttribute("im-re-append")==="true",shouldRemove:g,afterHeadMorphed:g},restoreFocus:!0};function H(l,v,u={}){l=F(l);let h=C(v),m=q(l,h,u),d=k(m,()=>x(m,l,h,e=>e.morphStyle==="innerHTML"?(D(e,l,h),Array.from(l.childNodes)):A(e,l,h)));return m.pantry.remove(),d}function A(l,v,u){let h=C(v);return D(l,h,u,v,v.nextSibling),Array.from(h.childNodes)}function k(l,v){if(!l.config.restoreFocus)return v();let u=document.activeElement;if(!(u instanceof HTMLInputElement||u instanceof HTMLTextAreaElement))return v();let{id:h,selectionStart:m,selectionEnd:d}=u,e=v();return h&&h!==document.activeElement?.id&&(u=l.target.querySelector(`[id="${h}"]`),u?.focus()),u&&!u.selectionEnd&&d&&u.setSelectionRange(m,d),e}let D=function(){function l(t,n,i,a=null,o=null){n instanceof HTMLTemplateElement&&i instanceof HTMLTemplateElement&&(n=n.content,i=i.content),a||=n.firstChild;for(let s of i.childNodes){if(a&&a!=o){let c=u(t,s,a,o);if(c){c!==a&&m(t,a,c),L(c,s,t),a=c.nextSibling;continue}}if(s instanceof Element&&t.persistentIds.has(s.id)){let c=d(n,s.id,a,t);L(c,s,t),a=c.nextSibling;continue}let p=v(n,s,a,t);p&&(a=p.nextSibling)}for(;a&&a!=o;){let s=a;a=a.nextSibling,h(t,s)}}function v(t,n,i,a){if(a.callbacks.beforeNodeAdded(n)===!1)return null;if(a.idMap.has(n)){let o=document.createElement(n.tagName);return t.insertBefore(o,i),L(o,n,a),a.callbacks.afterNodeAdded(o),o}else{let o=document.importNode(n,!0);return t.insertBefore(o,i),a.callbacks.afterNodeAdded(o),o}}let u=function(){function t(a,o,s,p){let c=null,T=o.nextSibling,b=0,E=s;for(;E&&E!=p;){if(i(E,o)){if(n(a,E,o))return E;c===null&&(a.idMap.has(E)||(c=E))}if(c===null&&T&&i(E,T)&&(b++,T=T.nextSibling,b>=2&&(c=void 0)),E.contains(document.activeElement))break;E=E.nextSibling}return c||null}function n(a,o,s){let p=a.idMap.get(o),c=a.idMap.get(s);if(!c||!p)return!1;for(let T of p)if(c.has(T))return!0;return!1}function i(a,o){let s=a,p=o;return s.nodeType===p.nodeType&&s.tagName===p.tagName&&(!s.id||s.id===p.id)}return t}();function h(t,n){if(t.idMap.has(n))r(t.pantry,n,null);else{if(t.callbacks.beforeNodeRemoved(n)===!1)return;n.parentNode?.removeChild(n),t.callbacks.afterNodeRemoved(n)}}function m(t,n,i){let a=n;for(;a&&a!==i;){let o=a;a=a.nextSibling,h(t,o)}return a}function d(t,n,i,a){let o=a.target.id===n&&a.target||a.target.querySelector(`[id="${n}"]`)||a.pantry.querySelector(`[id="${n}"]`);return e(o,a),r(t,o,i),o}function e(t,n){let i=t.id;for(;t=t.parentNode;){let a=n.idMap.get(t);a&&(a.delete(i),a.size||n.idMap.delete(t))}}function r(t,n,i){if(t.moveBefore)try{t.moveBefore(n,i)}catch{t.insertBefore(n,i)}else t.insertBefore(n,i)}return l}(),L=function(){function l(e,r,t){return t.ignoreActive&&e===document.activeElement?null:(t.callbacks.beforeNodeMorphed(e,r)===!1||(e instanceof HTMLHeadElement&&t.head.ignore||(e instanceof HTMLHeadElement&&t.head.style!=="morph"?w(e,r,t):(v(e,r,t),d(e,t)||D(t,e,r))),t.callbacks.afterNodeMorphed(e,r)),e)}function v(e,r,t){let n=r.nodeType;if(n===1){let i=e,a=r,o=i.attributes,s=a.attributes;for(let p of s)m(p.name,i,"update",t)||i.getAttribute(p.name)!==p.value&&i.setAttribute(p.name,p.value);for(let p=o.length-1;0<=p;p--){let c=o[p];if(c&&!a.hasAttribute(c.name)){if(m(c.name,i,"remove",t))continue;i.removeAttribute(c.name)}}d(i,t)||u(i,a,t)}(n===8||n===3)&&e.nodeValue!==r.nodeValue&&(e.nodeValue=r.nodeValue)}function u(e,r,t){if(e instanceof HTMLInputElement&&r instanceof HTMLInputElement&&r.type!=="file"){let n=r.value,i=e.value;h(e,r,"checked",t),h(e,r,"disabled",t),r.hasAttribute("value")?i!==n&&(m("value",e,"update",t)||(e.setAttribute("value",n),e.value=n)):m("value",e,"remove",t)||(e.value="",e.removeAttribute("value"))}else if(e instanceof HTMLOptionElement&&r instanceof HTMLOptionElement)h(e,r,"selected",t);else if(e instanceof HTMLTextAreaElement&&r instanceof HTMLTextAreaElement){let n=r.value,i=e.value;if(m("value",e,"update",t))return;n!==i&&(e.value=n),e.firstChild&&e.firstChild.nodeValue!==n&&(e.firstChild.nodeValue=n)}}function h(e,r,t,n){let i=r[t],a=e[t];if(i!==a){let o=m(t,e,"update",n);o||(e[t]=r[t]),i?o||e.setAttribute(t,""):m(t,e,"remove",n)||e.removeAttribute(t)}}function m(e,r,t,n){return e==="value"&&n.ignoreActiveValue&&r===document.activeElement?!0:n.callbacks.beforeAttributeUpdated(e,r,t)===!1}function d(e,r){return!!r.ignoreActiveValue&&e===document.activeElement&&e!==document.body}return l}();function x(l,v,u,h){if(l.head.block){let m=v.querySelector("head"),d=u.querySelector("head");if(m&&d){let e=w(m,d,l);return Promise.all(e).then(()=>{let r=Object.assign(l,{head:{block:!1,ignore:!0}});return h(r)})}}return h(l)}function w(l,v,u){let h=[],m=[],d=[],e=[],r=new Map;for(let n of v.children)r.set(n.outerHTML,n);for(let n of l.children){let i=r.has(n.outerHTML),a=u.head.shouldReAppend(n),o=u.head.shouldPreserve(n);i||o?a?m.push(n):(r.delete(n.outerHTML),d.push(n)):u.head.style==="append"?a&&(m.push(n),e.push(n)):u.head.shouldRemove(n)!==!1&&m.push(n)}e.push(...r.values());let t=[];for(let n of e){let i=document.createRange().createContextualFragment(n.outerHTML).firstChild;if(u.callbacks.beforeNodeAdded(i)!==!1){if("href"in i&&i.href||"src"in i&&i.src){let a,o=new Promise(function(s){a=s});i.addEventListener("load",function(){a()}),t.push(o)}l.appendChild(i),u.callbacks.afterNodeAdded(i),h.push(i)}}for(let n of m)u.callbacks.beforeNodeRemoved(n)!==!1&&(l.removeChild(n),u.callbacks.afterNodeRemoved(n));return u.head.afterHeadMorphed(l,{added:h,kept:d,removed:m}),t}let q=function(){function l(r,t,n){let{persistentIds:i,idMap:a}=d(r,t),o=v(n),s=o.morphStyle||"outerHTML";if(!["innerHTML","outerHTML"].includes(s))throw`Do not understand how to morph style ${s}`;return{target:r,newContent:t,config:o,morphStyle:s,ignoreActive:o.ignoreActive,ignoreActiveValue:o.ignoreActiveValue,restoreFocus:o.restoreFocus,idMap:a,persistentIds:i,pantry:u(),callbacks:o.callbacks,head:o.head}}function v(r){let t=Object.assign({},y);return Object.assign(t,r),t.callbacks=Object.assign({},y.callbacks,r.callbacks),t.head=Object.assign({},y.head,r.head),t}function u(){let r=document.createElement("div");return r.hidden=!0,document.body.insertAdjacentElement("afterend",r),r}function h(r){let t=Array.from(r.querySelectorAll("[id]"));return r.id&&t.push(r),t}function m(r,t,n,i){for(let a of i)if(t.has(a.id)){let o=a;for(;o;){let s=r.get(o);if(s==null&&(s=new Set,r.set(o,s)),s.add(a.id),o===n)break;o=o.parentElement}}}function d(r,t){let n=h(r),i=h(t),a=e(n,i),o=new Map;m(o,a,r,n);let s=t.__idiomorphRoot||t;return m(o,a,s,i),{persistentIds:a,idMap:o}}function e(r,t){let n=new Set,i=new Map;for(let{id:o,tagName:s}of r)i.has(o)?n.add(o):i.set(o,s);let a=new Set;for(let{id:o,tagName:s}of t)a.has(o)?n.add(o):i.get(o)===s&&a.add(o);for(let o of n)a.delete(o);return a}return l}(),{normalizeElement:F,normalizeParent:C}=function(){let l=new WeakSet;function v(d){return d instanceof Document?d.documentElement:d}function u(d){if(d==null)return document.createElement("div");if(typeof d=="string")return u(m(d));if(l.has(d))return d;if(d instanceof Node){if(d.parentNode)return new h(d);{let e=document.createElement("div");return e.append(d),e}}else{let e=document.createElement("div");for(let r of[...d])e.append(r);return e}}class h{constructor(e){this.originalNode=e,this.realParentNode=e.parentNode,this.previousSibling=e.previousSibling,this.nextSibling=e.nextSibling}get childNodes(){let e=[],r=this.previousSibling?this.previousSibling.nextSibling:this.realParentNode.firstChild;for(;r&&r!=this.nextSibling;)e.push(r),r=r.nextSibling;return e}querySelectorAll(e){return this.childNodes.reduce((r,t)=>{if(t instanceof Element){t.matches(e)&&r.push(t);let n=t.querySelectorAll(e);for(let i=0;i<n.length;i++)r.push(n[i])}return r},[])}insertBefore(e,r){return this.realParentNode.insertBefore(e,r)}moveBefore(e,r){return this.realParentNode.moveBefore(e,r)}get __idiomorphRoot(){return this.originalNode}}function m(d){let e=new DOMParser,r=d.replace(/<svg(\s[^>]*>|>)([\s\S]*?)<\/svg>/gim,"");if(r.match(/<\/html>/)||r.match(/<\/head>/)||r.match(/<\/body>/)){let t=e.parseFromString(d,"text/html");if(r.match(/<\/html>/))return l.add(t),t;{let n=t.firstChild;return n&&l.add(n),n}}else{let n=e.parseFromString("<body><template>"+d+"</template></body>","text/html").body.querySelector("template").content;return l.add(n),n}}return{normalizeElement:v,normalizeParent:u}}();return{morph:H,defaults:y}}();var B="rx-request",P=(H=>(H.Merge="rx-merge",H.MorphIgnoreActive="rx-morph-ignore-active",H))(P||{}),O="data-rx-script-processed",N=new Set,U=new Map,j="follow",f={},V=navigator.userAgent.toLowerCase().includes("firefox"),_=g=>{f.afterDocumentProcessed=g.afterDocumentProcessed,f.afterDocumentUpdate=g.afterDocumentUpdate,f.afterFetch=g.afterFetch,f.afterInitializeElement=g.afterInitializeElement,f.beforeDocumentProcessed=g.beforeDocumentProcessed,f.beforeDocumentUpdate=g.beforeDocumentUpdate,f.beforeFetch=g.beforeFetch,f.beforeInitializeElement=g.beforeInitializeElement,f.onElementAdded=g.onElementAdded,f.onElementMorphed=g.onElementMorphed,f.onElementRemoved=g.onElementRemoved,f.onElementTriggerError=g.onElementTriggerError},$=(g,y)=>{if(document.rxMutationObserver)return;y&&_(y),document.rxMutationObserver=new MutationObserver(e=>{e.forEach(r=>{r.type==="childList"&&(r.removedNodes.forEach(t=>{t instanceof HTMLElement&&(d(t),f.onElementRemoved&&f.onElementRemoved(t))}),r.addedNodes.forEach(t=>{t instanceof HTMLElement&&(q(t),m(t),f.onElementAdded&&f.onElementAdded(t))}))})}),document.addEventListener("DOMContentLoaded",h);function H(e){let r=e.dataset.rxMethod?.trim().toUpperCase()??"";switch(r){case"":case"GET":return"GET";case"POST":case"PUT":case"PATCH":case"DELETE":return r;default:{let t=`${r} is not a valid HTTP method.`;throw A(e,t),new Error(t)}}}function A(e,r){e._rxCallbacks.onElementTriggerError&&e._rxCallbacks.onElementTriggerError(r),f.onElementTriggerError&&f.onElementTriggerError(e,r),console.error(r)}function k(e,r=!1){let t=null,n=e.closest("fieldset");if(n)t=n;else if(e instanceof HTMLOptionElement){let i=e.closest("optgroup");i?t=i:t=e}else(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement||e instanceof HTMLSelectElement||e instanceof HTMLButtonElement)&&(t=e);t&&(r?t.setAttribute("disabled",""):t.removeAttribute("disabled"))}function D(e,r){let t=null,n=[];return(i,a)=>new Promise((o,s)=>{t&&clearTimeout(t),n.push({resolve:o,reject:s}),t=setTimeout(()=>{t=null,Promise.resolve(e(i,a)).then(p=>{n.forEach(({resolve:c})=>c(p))}).catch(p=>{n.forEach(({reject:c})=>c(p))}).finally(()=>{n=[]})},r)})}async function L(e){if(!this.dataset.rxDebounce){await x(this,e);return}let r=parseInt(this.dataset.rxDebounce,10);if(Number.isNaN(r)||r<=0)throw new Error(`Element ${this.id} data-rx-debounce attribute value must be a valid number greater than zero.`);let t=U.get(this.id);t?await t(this,e):(t=D(x,r),U.set(this.id,t),await t(this,e))}async function x(e,r){r.preventDefault();try{if(U.delete(e.id),N.has(e.id))throw new Error(`Element ${e.id} is already executing a request.`);let t=null;"form"in e&&e.form instanceof HTMLFormElement&&(t=e.form),t||(t=e.closest("form"));let n=new FormData(t??void 0,r instanceof SubmitEvent?r.submitter:null);!t&&"name"in e&&"value"in e&&typeof e.name=="string"&&typeof e.value=="string"&&n.append(e.name,e.value);let i=new Headers;i.set(B,"");let a=new AbortController,o={action:e.dataset.rxAction??"",method:H(e),redirect:j,body:n,headers:i,signal:a.signal};if(g?.addCookieToRequestHeader&&(Array.isArray(g.addCookieToRequestHeader)?g.addCookieToRequestHeader.forEach(T=>{v(o,T)}):v(o,g.addCookieToRequestHeader)),(g?.encodeRequestFormDataAsJson===void 0||g.encodeRequestFormDataAsJson===!0)&&u(o),/GET|DELETE/.test(o.method)){let T=new URLSearchParams(o.body);T.size&&(o.action+=(/\?/.test(o.action)?"&":"?")+T),o.body=""}let s={trigger:r,action:o.action,method:o.method,body:o.body,headers:o.headers,abort:a.abort.bind(a)};N.add(e.id);let p=e.dataset.rxDisableInFlight??null,c=null;try{if(p!==null&&p.toLowerCase()!=="false"&&k(e,!0),e._rxCallbacks.beforeFetch&&e._rxCallbacks.beforeFetch(s),f.beforeFetch&&f.beforeFetch(e,s),a.signal.aborted||(c=await fetch(o.action,o),a.signal.aborted))return;e._rxCallbacks.afterFetch&&e._rxCallbacks.afterFetch(o,c),f.afterFetch&&f.afterFetch(e,o,c)}catch(T){A(e,T)}finally{N.delete(e.id),p!==null&&p.toLowerCase()!=="false"&&k(e,!1)}if(!c){A(e,`Element ${e.id} has no response after request.`);return}if(c.status===202){let T=c.headers.get("location");T&&T.trim()!==""&&window.location.replace(T);return}if(c.status===204)return;if(c.status>=400){document.rxMutationObserver?.disconnect(),d(document.body),document.head.innerHTML="<title>Error</title>";let T=c.headers.get("content-type");if(T&&(T.includes("application/json")||T.includes("application/problem+json"))){let b=JSON.stringify(await c.json(),null,2);document.body.innerHTML=`<pre><code>${b}</code></pre>`}else document.body.innerText=await c.text();return}document.startViewTransition!==void 0?await document.startViewTransition(async()=>await l(e,c)).finished:await l(e,c),e._rxCallbacks.afterDocumentUpdate&&e._rxCallbacks.afterDocumentUpdate(),f.afterDocumentUpdate&&f.afterDocumentUpdate(e)}catch(t){A(e,t)}}function w(e){if(e.hasAttribute(O)){e.removeAttribute(O);return}let r=document.createElement("script");Array.from(e.attributes).forEach(n=>{r.setAttribute(n.name,n.value)}),r.setAttribute(O,""),r.textContent=e.textContent,r.async=!1,e.parentNode?.insertBefore(r,e),e.remove()}function q(e){if(V){if(e instanceof HTMLScriptElement){w(e);return}Array.from(e.querySelectorAll("script")).forEach(r=>{w(r)})}}function F(e,r){let t=`${r.target}-fragment`,n=e.find(i=>i instanceof HTMLTemplateElement&&i.id===t);if(!n)throw new Error(`Expected a response body fragment with id="${t}"`);if(!n.hasChildNodes)throw new Error(`Expected one or more child elements in fragment with id="${t}"`);return n}function C(e,r,t){let n=document.getElementById(t.target);if(!n)throw new Error(`Expected an HTML element with id="${t.target}"`);if(!(e._rxCallbacks.beforeDocumentUpdate&&e._rxCallbacks.beforeDocumentUpdate(r,t.strategy)===!1)&&!(f.beforeDocumentUpdate&&f.beforeDocumentUpdate(e,r,t.strategy)===!1))return n}async function l(e,r){let t=r?.headers.get("rx-merge");if(!t)throw new Error('Expected a "rx-merge" header object.');let n=JSON.parse(t),o=new DOMParser().parseFromString("<body><template>"+await r.text()+"</template></body>","text/html").body.querySelector("template")?.content,s=Array.from(o?.childNodes??[]);n.filter(b=>b.strategy==="swap"||b.strategy==="afterbegin"||b.strategy==="afterend"||b.strategy==="beforebegin"||b.strategy==="beforeend").forEach(b=>{let E=F(s,b);if(!E)return;let S=C(e,E,b);if(S)if(b.strategy==="swap")S.replaceWith(E.content);else{let M=Array.from(E.content.children);if(M.length===0)return;S.insertAdjacentElement(b.strategy,M[0]);let R=M[0];for(let I=1;I<M.length;I++)R.insertAdjacentElement("afterend",M[I]),R=M[I]}}),n.filter(b=>b.strategy==="morph").forEach(b=>{let E=F(s,b);if(!E)return;let S=C(e,E,b);if(!S)return;let M=r?.headers.has("rx-morph-ignore-active");z.morph(S,Array.from(E.content.children),{morphStyle:"outerHTML",ignoreActiveValue:M})?.forEach(R=>{R instanceof HTMLElement&&f.onElementMorphed&&f.onElementMorphed(R)})}),n.filter(b=>b.strategy==="remove").forEach(b=>{let E=document.getElementById(b.target);E&&(e._rxCallbacks.beforeDocumentUpdate&&e._rxCallbacks.beforeDocumentUpdate(E,b.strategy)===!1||f.beforeDocumentUpdate&&f.beforeDocumentUpdate(e,E,b.strategy)===!1||E.remove())})}function v(e,r){let n=`; ${document.cookie}`.split(`; ${r}=`);n.length===2&&e.headers&&e.headers.set(`${r}`,n.pop().split(";").shift()??"")}function u(e){if(e.headers?.set("Content-Type","application/json"),!(e.body instanceof FormData))return;let r={};e.body?.forEach((t,n)=>{t instanceof Blob||(Object.hasOwn(r,n)?(Array.isArray(r[n])||(r[n]=[r[n]]),r[n].push(t)):r[n]=t)}),e.body=JSON.stringify(r)}function h(){document.rxMutationObserver.observe(document.documentElement,{childList:!0,subtree:!0}),f.beforeDocumentProcessed&&f.beforeDocumentProcessed(),m(document.body),f.afterDocumentProcessed&&f.afterDocumentProcessed()}function m(e){let r=e.closest("[data-rx-ignore]");if(r&&r instanceof HTMLElement&&r.dataset.rxIgnore?.toLowerCase()!=="false")return;if(e.dataset.rxAction){let n=!0;if(f.beforeInitializeElement&&(n=f.beforeInitializeElement(e)),n){if(!e.id||e.id.trim()===""){let s='Element with "data-rx-action" must have a unique ID.';throw new Error(s)}let i={};Object.defineProperty(e,"addRxCallbacks",{value:s=>{i.afterDocumentUpdate=s.afterDocumentUpdate,i.afterFetch=s.afterFetch,i.beforeDocumentUpdate=s.beforeDocumentUpdate,i.beforeFetch=s.beforeFetch,i.onElementTriggerError=s.onElementTriggerError},writable:!1}),Object.defineProperty(e,"_rxCallbacks",{value:i,writable:!1});let o=e.dataset.rxTrigger;o||(o=e.matches("form")?"submit":e.matches("input:not([type=button]),select,textarea")?"change":"click",e.setAttribute("data-rx-trigger",o)),Object.freeze(e.id),e.addEventListener(e.dataset.rxTrigger,L),f.afterInitializeElement&&f.afterInitializeElement(e)}}let t=e.children;if(!(t?.length<=0))for(let n=0;n<t.length;n++){let i=t[n];i instanceof HTMLElement&&m(i)}}function d(e){e.dataset.rxTrigger&&e.removeEventListener(e.dataset.rxTrigger,L);let r=e.children;if(!(r?.length<=0))for(let t=0;t<r.length;t++){let n=r[t];n instanceof HTMLElement&&d(n)}}},J={init:Object.freeze($),addCallbacks:Object.freeze(_)},X=J;export{B as RxRequestHeader,P as RxResponseHeaders,X as razorx};
//# sourceMappingURL=razorx.js.map
